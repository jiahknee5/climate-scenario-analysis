<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hurricane Scenario Analysis - C-BOTTLE Climate Risk Dashboard</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2E3440 0%, #3B4252 100%);
            color: #D8DEE9;
            min-height: 100vh;
        }

        .header {
            background: rgba(46, 52, 64, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(136, 192, 208, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header h1 {
            color: #88C0D0;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #D8DEE9;
            opacity: 0.8;
            font-size: 1.1rem;
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: 350px 1fr 350px 1fr;
            grid-template-rows: auto 1fr;
            gap: 1rem;
            padding: 1rem;
            height: calc(100vh - 120px);
        }

        .controls-panel {
            grid-row: 1 / 3;
            background: rgba(59, 66, 82, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(136, 192, 208, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .controls-panel h3 {
            color: #88C0D0;
            font-size: 1.3rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .data-toggle {
            display: flex;
            background: rgba(46, 52, 64, 0.5);
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 1.5rem;
        }

        .toggle-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #D8DEE9;
        }

        .toggle-btn.active {
            background: #5E81AC;
            color: white;
            box-shadow: 0 2px 8px rgba(94, 129, 172, 0.4);
        }

        .toggle-btn:hover:not(.active) {
            background: rgba(94, 129, 172, 0.2);
        }

        .control-group {
            margin-bottom: 1.5rem;
        }

        .control-group label {
            display: block;
            color: #88C0D0;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .control-group select {
            width: 100%;
            padding: 10px;
            background: rgba(46, 52, 64, 0.8);
            border: 1px solid rgba(136, 192, 208, 0.3);
            border-radius: 6px;
            color: #D8DEE9;
            font-size: 0.9rem;
        }

        .control-group select:focus {
            outline: none;
            border-color: #5E81AC;
            box-shadow: 0 0 0 2px rgba(94, 129, 172, 0.2);
        }

        .map-container {
            background: rgba(59, 66, 82, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(136, 192, 208, 0.2);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .map-header {
            background: rgba(46, 52, 64, 0.8);
            padding: 1rem;
            border-bottom: 1px solid rgba(136, 192, 208, 0.2);
        }

        .map-header h4 {
            color: #88C0D0;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .map-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .map {
            width: 100%;
            height: calc(100% - 80px);
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(46, 52, 64, 0.9);
            color: #88C0D0;
            padding: 1rem 2rem;
            border-radius: 8px;
            border: 1px solid rgba(136, 192, 208, 0.3);
        }

        .metrics-panel {
            background: rgba(59, 66, 82, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(136, 192, 208, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .metrics-panel h4 {
            color: #88C0D0;
            font-size: 1.2rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .metric-box {
            background: rgba(46, 52, 64, 0.6);
            border: 1px solid rgba(136, 192, 208, 0.2);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .metric-label {
            color: #88C0D0;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            color: #D8DEE9;
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .metric-unit {
            color: #D8DEE9;
            opacity: 0.7;
            font-size: 0.8rem;
        }

        .metric-change {
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }

        .metric-change.positive {
            color: #BF616A;
        }

        .metric-change.negative {
            color: #A3BE8C;
        }

        .scenario-info {
            background: rgba(94, 129, 172, 0.1);
            border: 1px solid rgba(94, 129, 172, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .scenario-info h5 {
            color: #5E81AC;
            margin-bottom: 0.5rem;
        }

        .scenario-info p {
            font-size: 0.9rem;
            line-height: 1.4;
        }

        @media (max-width: 1200px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto auto;
                height: auto;
            }
            
            .controls-panel {
                grid-row: auto;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üå™Ô∏è Hurricane Scenario Analysis</h1>
        <p>Interactive climate risk assessment with comprehensive scenario modeling and real-time hurricane track visualization</p>
    </div>

    <div class="dashboard-container">
        <!-- Left Controls Panel -->
        <div class="controls-panel">
            <h3>üéõÔ∏è Left Panel - Climate Scenarios</h3>
            
            <div class="data-toggle">
                <div class="toggle-btn active" onclick="setDataType(1, 'historical')">Historical Data</div>
                <div class="toggle-btn" onclick="setDataType(1, 'projected')">Climate Projections</div>
            </div>
            
            <div id="historical-controls-1">
                <div class="control-group">
                    <label>üìÖ Historical Year (2010-2024)</label>
                    <select id="year1">
                        <option value="2010">2010</option>
                        <option value="2011">2011</option>
                        <option value="2012">2012</option>
                        <option value="2013">2013</option>
                        <option value="2014">2014</option>
                        <option value="2015">2015</option>
                        <option value="2016">2016</option>
                        <option value="2017" selected>2017</option>
                        <option value="2018">2018</option>
                        <option value="2019">2019</option>
                        <option value="2020">2020</option>
                        <option value="2021">2021</option>
                        <option value="2022">2022</option>
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                    </select>
                </div>
            </div>
            
            <div id="projected-controls-1" style="display: none;">
                <div class="control-group">
                    <label>üå°Ô∏è Climate Scenario</label>
                    <select id="scenario1">
                        <option value="baseline">Baseline (Current Trends)</option>
                        <option value="warming_mid">+2¬∞C Warming (Paris Agreement)</option>
                        <option value="warming_high">+4¬∞C Warming (High Emissions)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>üìÜ Future Decade</label>
                    <select id="decade1">
                        <option value="2030s">2030s (2030-2039)</option>
                        <option value="2050s">2050s (2050-2059)</option>
                        <option value="2070s">2070s (2070-2079)</option>
                        <option value="2090s">2090s (2090-2099)</option>
                    </select>
                </div>
            </div>

            <div class="scenario-info" id="scenario-info-1">
                <h5>Historical Analysis</h5>
                <p>Viewing actual hurricane data from HURDAT2 database with verified tracks and intensities.</p>
            </div>
        </div>

        <!-- Left Map -->
        <div class="map-container">
            <div class="map-header">
                <h4 id="map-title-1">Historical Hurricane Data - 2017</h4>
            </div>
            <div id="map1" class="map"></div>
            <div id="loading1" class="loading">Loading hurricane data...</div>
        </div>

        <!-- Right Controls Panel -->
        <div class="controls-panel">
            <h3>üéõÔ∏è Right Panel - Comparison View</h3>
            
            <div class="data-toggle">
                <div class="toggle-btn" onclick="setDataType(2, 'historical')">Historical Data</div>
                <div class="toggle-btn active" onclick="setDataType(2, 'projected')">Climate Projections</div>
            </div>
            
            <div id="historical-controls-2" style="display: none;">
                <div class="control-group">
                    <label>üìÖ Historical Year (2010-2024)</label>
                    <select id="year2">
                        <option value="2010">2010</option>
                        <option value="2011">2011</option>
                        <option value="2012">2012</option>
                        <option value="2013">2013</option>
                        <option value="2014">2014</option>
                        <option value="2015">2015</option>
                        <option value="2016">2016</option>
                        <option value="2017">2017</option>
                        <option value="2018">2018</option>
                        <option value="2019">2019</option>
                        <option value="2020" selected>2020</option>
                        <option value="2021">2021</option>
                        <option value="2022">2022</option>
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                    </select>
                </div>
            </div>
            
            <div id="projected-controls-2">
                <div class="control-group">
                    <label>üå°Ô∏è Climate Scenario</label>
                    <select id="scenario2">
                        <option value="baseline">Baseline (Current Trends)</option>
                        <option value="warming_mid">+2¬∞C Warming (Paris Agreement)</option>
                        <option value="warming_high" selected>+4¬∞C Warming (High Emissions)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>üìÜ Future Decade</label>
                    <select id="decade2">
                        <option value="2030s">2030s (2030-2039)</option>
                        <option value="2050s">2050s (2050-2059)</option>
                        <option value="2070s">2070s (2070-2079)</option>
                        <option value="2090s" selected>2090s (2090-2099)</option>
                    </select>
                </div>
            </div>

            <div class="scenario-info" id="scenario-info-2">
                <h5>+4¬∞C Warming Scenario - 2090s</h5>
                <p>High-emissions pathway showing significant intensification of hurricane activity with increased frequency of Category 4-5 storms.</p>
            </div>
        </div>

        <!-- Right Map -->
        <div class="map-container">
            <div class="map-header">
                <h4 id="map-title-2">Climate Projection - +4¬∞C Warming (2090s)</h4>
            </div>
            <div id="map2" class="map"></div>
            <div id="loading2" class="loading">Loading climate projections...</div>
        </div>
    </div>

    <!-- Metrics Panels (positioned absolutely to overlay on maps) -->
    <div class="metrics-panel" style="position: absolute; top: 140px; left: 370px; width: 200px; z-index: 100;">
        <h4>üìä Statistics</h4>
        <div id="metrics-content-1">
            <div class="metric-box">
                <div class="metric-label">Named Storms</div>
                <div class="metric-value">17</div>
                <div class="metric-unit">per season</div>
            </div>
            <div class="metric-box">
                <div class="metric-label">Major Hurricanes</div>
                <div class="metric-value">6</div>
                <div class="metric-unit">Cat 3-5</div>
            </div>
            <div class="metric-box">
                <div class="metric-label">US Landfalls</div>
                <div class="metric-value">3</div>
                <div class="metric-unit">storms</div>
            </div>
        </div>
    </div>

    <div class="metrics-panel" style="position: absolute; top: 140px; right: 20px; width: 200px; z-index: 100;">
        <h4>üìä Projections</h4>
        <div id="metrics-content-2">
            <div class="metric-box">
                <div class="metric-label">Named Storms</div>
                <div class="metric-value">24</div>
                <div class="metric-unit">per season</div>
                <div class="metric-change positive">+41% vs baseline</div>
            </div>
            <div class="metric-box">
                <div class="metric-label">Major Hurricanes</div>
                <div class="metric-value">11</div>
                <div class="metric-unit">Cat 3-5</div>
                <div class="metric-change positive">+83% vs baseline</div>
            </div>
            <div class="metric-box">
                <div class="metric-label">US Landfalls</div>
                <div class="metric-value">5</div>
                <div class="metric-unit">storms</div>
                <div class="metric-change positive">+67% vs baseline</div>
            </div>
        </div>
    </div>

    <script>
        // Mapbox access token
        mapboxgl.accessToken = 'pk.eyJ1IjoiY2xpbWF0ZS1hbmFseXNpcyIsImEiOiJjbHB3Nno4bHcwNnc3Mmxvam55YjVmbThpIn0.KFa7VEgqVQNPQ2wVkOzS9g';

        // Initialize maps
        let map1, map2;
        let dataType1 = 'historical';
        let dataType2 = 'projected';

        // Properties data for risk assessment
        const properties = [
            {"property_id":"PROP001","name":"Miami Beach Resort","latitude":25.7907,"longitude":-80.13,"value_usd":85000000,"building_type":"hotel","construction_year":2005,"stories":15,"occupancy":"commercial"},
            {"property_id":"PROP002","name":"Houston Office Tower","latitude":29.7604,"longitude":-95.3698,"value_usd":120000000,"building_type":"office","construction_year":2010,"stories":25,"occupancy":"commercial"},
            {"property_id":"PROP003","name":"New Orleans Historic Building","latitude":29.9511,"longitude":-90.0715,"value_usd":45000000,"building_type":"mixed_use","construction_year":1920,"stories":4,"occupancy":"mixed"},
            {"property_id":"PROP004","name":"Tampa Bay Marina Complex","latitude":27.9506,"longitude":-82.4572,"value_usd":65000000,"building_type":"marina","construction_year":2015,"stories":3,"occupancy":"commercial"},
            {"property_id":"PROP005","name":"Jacksonville Distribution Center","latitude":30.3322,"longitude":-81.6557,"value_usd":55000000,"building_type":"warehouse","construction_year":2018,"stories":1,"occupancy":"industrial"}
        ];

        // Historical hurricane data (sample for 2017)
        const historicalData = {
            "2017": [
                {
                    "name": "Hurricane Harvey",
                    "year": 2017,
                    "peak_category": 4,
                    "track": [
                        {"lat": 13.4, "lon": -25.6, "wind_mph": 25, "category": 0, "pressure_mb": 1008},
                        {"lat": 15.1, "lon": -30.2, "wind_mph": 35, "category": 0, "pressure_mb": 1005},
                        {"lat": 17.8, "lon": -45.7, "wind_mph": 40, "category": 0, "pressure_mb": 1003},
                        {"lat": 19.2, "lon": -55.4, "wind_mph": 65, "category": 0, "pressure_mb": 999},
                        {"lat": 20.1, "lon": -65.8, "wind_mph": 80, "category": 1, "pressure_mb": 990},
                        {"lat": 21.5, "lon": -75.3, "wind_mph": 100, "category": 2, "pressure_mb": 975},
                        {"lat": 22.8, "lon": -85.1, "wind_mph": 130, "category": 4, "pressure_mb": 940},
                        {"lat": 24.2, "lon": -90.5, "wind_mph": 125, "category": 3, "pressure_mb": 945},
                        {"lat": 26.1, "lon": -94.2, "wind_mph": 130, "category": 4, "pressure_mb": 938},
                        {"lat": 28.5, "lon": -96.8, "wind_mph": 130, "category": 4, "pressure_mb": 940}
                    ],
                    "landfall": true,
                    "damages_billions": 125
                },
                {
                    "name": "Hurricane Irma",
                    "year": 2017,
                    "peak_category": 5,
                    "track": [
                        {"lat": 16.7, "lon": -27.9, "wind_mph": 30, "category": 0, "pressure_mb": 1006},
                        {"lat": 17.9, "lon": -35.4, "wind_mph": 70, "category": 0, "pressure_mb": 995},
                        {"lat": 18.5, "lon": -42.1, "wind_mph": 115, "category": 3, "pressure_mb": 960},
                        {"lat": 18.8, "lon": -50.2, "wind_mph": 150, "category": 4, "pressure_mb": 930},
                        {"lat": 19.2, "lon": -58.7, "wind_mph": 185, "category": 5, "pressure_mb": 914},
                        {"lat": 20.1, "lon": -65.4, "wind_mph": 180, "category": 5, "pressure_mb": 916},
                        {"lat": 21.8, "lon": -70.2, "wind_mph": 175, "category": 5, "pressure_mb": 918},
                        {"lat": 23.9, "lon": -74.8, "wind_mph": 160, "category": 4, "pressure_mb": 925},
                        {"lat": 25.4, "lon": -78.1, "wind_mph": 130, "category": 4, "pressure_mb": 940},
                        {"lat": 27.2, "lon": -80.8, "wind_mph": 120, "category": 3, "pressure_mb": 948},
                        {"lat": 29.8, "lon": -82.5, "wind_mph": 105, "category": 2, "pressure_mb": 960}
                    ],
                    "landfall": true,
                    "damages_billions": 77.2
                },
                {
                    "name": "Hurricane Maria",
                    "year": 2017,
                    "peak_category": 5,
                    "track": [
                        {"lat": 13.8, "lon": -45.2, "wind_mph": 40, "category": 0, "pressure_mb": 1004},
                        {"lat": 15.1, "lon": -52.8, "wind_mph": 65, "category": 0, "pressure_mb": 996},
                        {"lat": 16.2, "lon": -58.4, "wind_mph": 90, "category": 1, "pressure_mb": 982},
                        {"lat": 17.0, "lon": -62.1, "wind_mph": 120, "category": 3, "pressure_mb": 958},
                        {"lat": 17.9, "lon": -65.8, "wind_mph": 165, "category": 5, "pressure_mb": 908},
                        {"lat": 19.2, "lon": -68.4, "wind_mph": 155, "category": 4, "pressure_mb": 918},
                        {"lat": 21.8, "lon": -70.2, "wind_mph": 125, "category": 3, "pressure_mb": 950},
                        {"lat": 25.4, "lon": -71.8, "wind_mph": 110, "category": 2, "pressure_mb": 965},
                        {"lat": 30.1, "lon": -72.5, "wind_mph": 85, "category": 1, "pressure_mb": 985}
                    ],
                    "landfall": true,
                    "damages_billions": 102.2
                }
            ]
        };

        // Comprehensive projected data for all scenarios and decades
        const projectedData = {
            "2030s": {
                "baseline": {
                    "decade": "2030-2039",
                    "scenario": "baseline",
                    "total_storms": 120,
                    "annual_average": 12.0,
                    "major_hurricanes": 32,
                    "major_hurricane_pct": 0.27,
                    "hurricanes": generateHurricanes("2030s", "baseline", 12, 3)
                },
                "warming_mid": {
                    "decade": "2030-2039",
                    "scenario": "warming_mid",
                    "total_storms": 140,
                    "annual_average": 14.0,
                    "major_hurricanes": 42,
                    "major_hurricane_pct": 0.30,
                    "hurricanes": generateHurricanes("2030s", "warming_mid", 14, 4)
                },
                "warming_high": {
                    "decade": "2030-2039",
                    "scenario": "warming_high",
                    "total_storms": 160,
                    "annual_average": 16.0,
                    "major_hurricanes": 56,
                    "major_hurricane_pct": 0.35,
                    "hurricanes": generateHurricanes("2030s", "warming_high", 16, 6)
                }
            },
            "2050s": {
                "baseline": {
                    "decade": "2050-2059",
                    "scenario": "baseline",
                    "total_storms": 125,
                    "annual_average": 12.5,
                    "major_hurricanes": 35,
                    "major_hurricane_pct": 0.28,
                    "hurricanes": generateHurricanes("2050s", "baseline", 13, 4)
                },
                "warming_mid": {
                    "decade": "2050-2059",
                    "scenario": "warming_mid",
                    "total_storms": 155,
                    "annual_average": 15.5,
                    "major_hurricanes": 54,
                    "major_hurricane_pct": 0.35,
                    "hurricanes": generateHurricanes("2050s", "warming_mid", 16, 5)
                },
                "warming_high": {
                    "decade": "2050-2059",
                    "scenario": "warming_high",
                    "total_storms": 190,
                    "annual_average": 19.0,
                    "major_hurricanes": 80,
                    "major_hurricane_pct": 0.42,
                    "hurricanes": generateHurricanes("2050s", "warming_high", 19, 8)
                }
            },
            "2070s": {
                "baseline": {
                    "decade": "2070-2079",
                    "scenario": "baseline",
                    "total_storms": 130,
                    "annual_average": 13.0,
                    "major_hurricanes": 39,
                    "major_hurricane_pct": 0.30,
                    "hurricanes": generateHurricanes("2070s", "baseline", 13, 4)
                },
                "warming_mid": {
                    "decade": "2070-2079",
                    "scenario": "warming_mid",
                    "total_storms": 170,
                    "annual_average": 17.0,
                    "major_hurricanes": 68,
                    "major_hurricane_pct": 0.40,
                    "hurricanes": generateHurricanes("2070s", "warming_mid", 17, 7)
                },
                "warming_high": {
                    "decade": "2070-2079",
                    "scenario": "warming_high",
                    "total_storms": 220,
                    "annual_average": 22.0,
                    "major_hurricanes": 110,
                    "major_hurricane_pct": 0.50,
                    "hurricanes": generateHurricanes("2070s", "warming_high", 22, 11)
                }
            },
            "2090s": {
                "baseline": {
                    "decade": "2090-2099",
                    "scenario": "baseline",
                    "total_storms": 135,
                    "annual_average": 13.5,
                    "major_hurricanes": 41,
                    "major_hurricane_pct": 0.30,
                    "hurricanes": generateHurricanes("2090s", "baseline", 14, 4)
                },
                "warming_mid": {
                    "decade": "2090-2099",
                    "scenario": "warming_mid",
                    "total_storms": 185,
                    "annual_average": 18.5,
                    "major_hurricanes": 83,
                    "major_hurricane_pct": 0.45,
                    "hurricanes": generateHurricanes("2090s", "warming_mid", 19, 8)
                },
                "warming_high": {
                    "decade": "2090-2099",
                    "scenario": "warming_high",
                    "total_storms": 250,
                    "annual_average": 25.0,
                    "major_hurricanes": 150,
                    "major_hurricane_pct": 0.60,
                    "hurricanes": generateHurricanes("2090s", "warming_high", 25, 15)
                }
            }
        };

        // Function to generate realistic hurricane tracks
        function generateHurricanes(decade, scenario, count, majorCount) {
            const hurricanes = [];
            const names = ['Alex', 'Bonnie', 'Colin', 'Danielle', 'Earl', 'Fiona', 'Gaston', 'Hermine', 'Ian', 'Julia', 'Karl', 'Lisa', 'Martin', 'Nicole', 'Owen', 'Paula', 'Richard', 'Shary', 'Tobias', 'Virginie', 'Walter', 'Xina', 'York', 'Zelda', 'Ana'];
            
            for (let i = 0; i < count; i++) {
                const hurricane = {
                    id: `${decade}_H${String(i + 1).padStart(2, '0')}`,
                    name: names[i % names.length],
                    formation_date: `${decade.slice(0, 4)}-${6 + Math.floor(Math.random() * 4)}-${String(Math.floor(Math.random() * 28) + 1).padStart(2, '0')}T00:00:00`,
                    peak_category: i < majorCount ? Math.floor(Math.random() * 3) + 3 : Math.floor(Math.random() * 3) + 1,
                    track: generateRealisticTrack(scenario),
                    genesis_region: getGenesisRegion()
                };
                hurricanes.push(hurricane);
            }
            
            return hurricanes;
        }

        // Function to generate meteorologically realistic hurricane tracks
        function generateRealisticTrack(scenario) {
            const track = [];
            const patterns = [
                'cape_verde',     // Classic Cape Verde recurve
                'gulf_mexico',    // Gulf formation
                'caribbean',      // Caribbean formation
                'western_atlantic' // Western Atlantic formation
            ];
            
            const pattern = patterns[Math.floor(Math.random() * patterns.length)];
            const intensityMultiplier = scenario === 'warming_high' ? 1.3 : scenario === 'warming_mid' ? 1.15 : 1.0;
            
            switch (pattern) {
                case 'cape_verde':
                    return generateCapeVerdeTrack(intensityMultiplier);
                case 'gulf_mexico':
                    return generateGulfTrack(intensityMultiplier);
                case 'caribbean':
                    return generateCaribbeanTrack(intensityMultiplier);
                case 'western_atlantic':
                    return generateWesternAtlanticTrack(intensityMultiplier);
                default:
                    return generateCapeVerdeTrack(intensityMultiplier);
            }
        }

        function generateCapeVerdeTrack(intensityMultiplier) {
            const track = [];
            let lat = 10 + Math.random() * 5;
            let lon = -20 - Math.random() * 15;
            let intensity = 25;
            
            // Formation and early development
            for (let i = 0; i < 15; i++) {
                lat += 0.8 + Math.random() * 0.4;
                lon -= 3 + Math.random() * 2;
                intensity = Math.min(185, intensity + (2 + Math.random() * 3) * intensityMultiplier);
                
                track.push({
                    lat: Math.round(lat * 100) / 100,
                    lon: Math.round(lon * 100) / 100,
                    wind_mph: Math.round(intensity),
                    category: getCategory(intensity),
                    pressure_mb: Math.round(1010 - (intensity - 25) * 0.8),
                    radius_nm: 50 + Math.random() * 100
                });
                
                // Recurve northward as it approaches North America
                if (lon < -60) {
                    lat += 0.5 + Math.random() * 0.3;
                    lon -= 1 + Math.random();
                }
            }
            
            return track;
        }

        function generateGulfTrack(intensityMultiplier) {
            const track = [];
            let lat = 18 + Math.random() * 8;
            let lon = -82 - Math.random() * 15;
            let intensity = 30;
            
            // Rapid intensification in warm Gulf waters
            for (let i = 0; i < 8; i++) {
                lat += 0.5 + Math.random() * 0.5;
                lon -= 0.5 + Math.random() * 0.5;
                intensity = Math.min(175, intensity + (8 + Math.random() * 7) * intensityMultiplier);
                
                track.push({
                    lat: Math.round(lat * 100) / 100,
                    lon: Math.round(lon * 100) / 100,
                    wind_mph: Math.round(intensity),
                    category: getCategory(intensity),
                    pressure_mb: Math.round(1010 - (intensity - 30) * 0.9),
                    radius_nm: 40 + Math.random() * 80
                });
            }
            
            return track;
        }

        function generateCaribbeanTrack(intensityMultiplier) {
            const track = [];
            let lat = 12 + Math.random() * 6;
            let lon = -60 - Math.random() * 20;
            let intensity = 35;
            
            // Move west-northwest through Caribbean
            for (let i = 0; i < 12; i++) {
                lat += 0.3 + Math.random() * 0.4;
                lon -= 1.5 + Math.random();
                intensity = Math.min(165, intensity + (4 + Math.random() * 4) * intensityMultiplier);
                
                track.push({
                    lat: Math.round(lat * 100) / 100,
                    lon: Math.round(lon * 100) / 100,
                    wind_mph: Math.round(intensity),
                    category: getCategory(intensity),
                    pressure_mb: Math.round(1008 - (intensity - 35) * 0.85),
                    radius_nm: 45 + Math.random() * 90
                });
            }
            
            return track;
        }

        function generateWesternAtlanticTrack(intensityMultiplier) {
            const track = [];
            let lat = 25 + Math.random() * 10;
            let lon = -65 - Math.random() * 10;
            let intensity = 40;
            
            // Move north-northeast along coast
            for (let i = 0; i < 10; i++) {
                lat += 1 + Math.random() * 0.5;
                lon += 0.5 + Math.random() * 0.3;
                intensity = Math.min(155, intensity + (3 + Math.random() * 3) * intensityMultiplier);
                
                track.push({
                    lat: Math.round(lat * 100) / 100,
                    lon: Math.round(lon * 100) / 100,
                    wind_mph: Math.round(intensity),
                    category: getCategory(intensity),
                    pressure_mb: Math.round(1006 - (intensity - 40) * 0.8),
                    radius_nm: 60 + Math.random() * 120
                });
            }
            
            return track;
        }

        function getCategory(windSpeed) {
            if (windSpeed < 39) return 0;
            if (windSpeed < 74) return 0;
            if (windSpeed < 96) return 1;
            if (windSpeed < 111) return 2;
            if (windSpeed < 129) return 3;
            if (windSpeed < 157) return 4;
            return 5;
        }

        function getGenesisRegion() {
            const regions = ['Cape Verde', 'Gulf of Mexico', 'Caribbean', 'Western Atlantic'];
            return regions[Math.floor(Math.random() * regions.length)];
        }

        // Initialize maps
        function initMaps() {
            map1 = new mapboxgl.Map({
                container: 'map1',
                style: 'mapbox://styles/mapbox/dark-v11',
                center: [-75, 25],
                zoom: 3
            });

            map2 = new mapboxgl.Map({
                container: 'map2',
                style: 'mapbox://styles/mapbox/dark-v11',
                center: [-75, 25],
                zoom: 3
            });

            map1.on('load', () => {
                document.getElementById('loading1').style.display = 'none';
                addProperties(map1);
                updateMap(1);
            });
            
            map2.on('load', () => {
                document.getElementById('loading2').style.display = 'none';
                addProperties(map2);
                updateMap(2);
            });
        }

        // Add property markers to map
        function addProperties(map) {
            properties.forEach(property => {
                const el = document.createElement('div');
                el.className = 'property-marker';
                el.style.width = '12px';
                el.style.height = '12px';
                el.style.backgroundColor = '#5E81AC';
                el.style.borderRadius = '50%';
                el.style.border = '2px solid #88C0D0';
                el.style.cursor = 'pointer';

                new mapboxgl.Marker(el)
                    .setLngLat([property.longitude, property.latitude])
                    .setPopup(new mapboxgl.Popup().setHTML(`
                        <strong>${property.name}</strong><br>
                        Value: $${(property.value_usd / 1000000).toFixed(1)}M<br>
                        Type: ${property.building_type}
                    `))
                    .addTo(map);
            });
        }

        // Set data type for a map
        function setDataType(mapNum, type) {
            if (mapNum === 1) {
                dataType1 = type;
                document.querySelectorAll('.controls-panel:first-child .toggle-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                
                document.getElementById('historical-controls-1').style.display = type === 'historical' ? 'block' : 'none';
                document.getElementById('projected-controls-1').style.display = type === 'projected' ? 'block' : 'none';
            } else {
                dataType2 = type;
                document.querySelectorAll('.controls-panel:last-of-type .toggle-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                
                document.getElementById('historical-controls-2').style.display = type === 'historical' ? 'block' : 'none';
                document.getElementById('projected-controls-2').style.display = type === 'projected' ? 'block' : 'none';
            }
            
            updateMap(mapNum);
            updateScenarioInfo(mapNum);
        }

        // Update map with hurricane data
        function updateMap(mapNum) {
            const map = mapNum === 1 ? map1 : map2;
            const dataType = mapNum === 1 ? dataType1 : dataType2;
            
            // Clear existing hurricane layers
            clearHurricaneData(map);
            
            let hurricanes = [];
            let title = '';
            let stats = {};
            
            if (dataType === 'historical') {
                const year = document.getElementById('year' + mapNum).value;
                hurricanes = historicalData[year] || [];
                title = `Historical Hurricane Data - ${year}`;
                
                stats = {
                    named_storms: hurricanes.length,
                    major_hurricanes: hurricanes.filter(h => h.peak_category >= 3).length,
                    landfalls: hurricanes.filter(h => h.landfall).length
                };
            } else {
                const scenario = document.getElementById('scenario' + mapNum).value;
                const decade = document.getElementById('decade' + mapNum).value;
                
                if (projectedData[decade] && projectedData[decade][scenario]) {
                    const data = projectedData[decade][scenario];
                    hurricanes = data.hurricanes.slice(0, 8); // Show sample of hurricanes
                    
                    const scenarioNames = {
                        'baseline': 'Baseline',
                        'warming_mid': '+2¬∞C Warming',
                        'warming_high': '+4¬∞C Warming'
                    };
                    
                    title = `${scenarioNames[scenario]} - ${decade}`;
                    
                    stats = {
                        named_storms: Math.round(data.annual_average),
                        major_hurricanes: Math.round(data.annual_average * data.major_hurricane_pct),
                        landfalls: Math.round(data.annual_average * 0.3)
                    };
                }
            }
            
            // Update map title
            document.getElementById('map-title-' + mapNum).textContent = title;
            
            // Add hurricane tracks to map
            addHurricaneTracks(map, hurricanes);
            
            // Update metrics
            updateMetrics(mapNum, stats, dataType === 'projected');
        }

        // Clear hurricane data from map
        function clearHurricaneData(map) {
            const layers = map.getStyle().layers;
            layers.forEach(layer => {
                if (layer.id.startsWith('hurricane-') || layer.id.startsWith('track-')) {
                    try {
                        map.removeLayer(layer.id);
                        map.removeSource(layer.id);
                    } catch (e) {
                        // Layer might not exist
                    }
                }
            });
        }

        // Add hurricane tracks to map
        function addHurricaneTracks(map, hurricanes) {
            hurricanes.forEach((hurricane, index) => {
                const trackId = `track-${index}`;
                const lineString = {
                    type: 'Feature',
                    geometry: {
                        type: 'LineString',
                        coordinates: hurricane.track.map(point => [point.lon, point.lat])
                    },
                    properties: {
                        name: hurricane.name,
                        peak_category: hurricane.peak_category
                    }
                };

                // Add track line
                map.addSource(trackId, {
                    type: 'geojson',
                    data: lineString
                });

                const color = getHurricaneColor(hurricane.peak_category);
                
                map.addLayer({
                    id: trackId,
                    type: 'line',
                    source: trackId,
                    layout: {
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    paint: {
                        'line-color': color,
                        'line-width': 3,
                        'line-opacity': 0.8
                    }
                });

                // Add hurricane points
                hurricane.track.forEach((point, pointIndex) => {
                    const pointId = `hurricane-${index}-${pointIndex}`;
                    
                    map.addSource(pointId, {
                        type: 'geojson',
                        data: {
                            type: 'Feature',
                            geometry: {
                                type: 'Point',
                                coordinates: [point.lon, point.lat]
                            },
                            properties: {
                                name: hurricane.name,
                                wind_mph: point.wind_mph,
                                category: point.category,
                                pressure_mb: point.pressure_mb
                            }
                        }
                    });

                    map.addLayer({
                        id: pointId,
                        type: 'circle',
                        source: pointId,
                        paint: {
                            'circle-radius': 4 + point.category,
                            'circle-color': getHurricaneColor(point.category),
                            'circle-stroke-width': 1,
                            'circle-stroke-color': '#ffffff',
                            'circle-opacity': 0.8
                        }
                    });

                    // Add popup on click
                    map.on('click', pointId, (e) => {
                        new mapboxgl.Popup()
                            .setLngLat(e.lngLat)
                            .setHTML(`
                                <strong>${hurricane.name}</strong><br>
                                Category: ${point.category}<br>
                                Wind Speed: ${point.wind_mph} mph<br>
                                Pressure: ${point.pressure_mb} mb
                            `)
                            .addTo(map);
                    });

                    map.on('mouseenter', pointId, () => {
                        map.getCanvas().style.cursor = 'pointer';
                    });

                    map.on('mouseleave', pointId, () => {
                        map.getCanvas().style.cursor = '';
                    });
                });
            });
        }

        // Get hurricane color based on category
        function getHurricaneColor(category) {
            const colors = {
                0: '#88C0D0',  // Tropical Storm
                1: '#A3BE8C',  // Category 1
                2: '#EBCB8B',  // Category 2
                3: '#D08770',  // Category 3
                4: '#BF616A',  // Category 4
                5: '#B48EAD'   // Category 5
            };
            return colors[category] || colors[0];
        }

        // Update metrics panel
        function updateMetrics(mapNum, stats, isProjected) {
            const metricsContent = document.getElementById('metrics-content-' + mapNum);
            const baseline = { named_storms: 12, major_hurricanes: 4, landfalls: 3 };
            
            let html = '';
            
            // Named storms
            const namedChange = isProjected ? Math.round(((stats.named_storms - baseline.named_storms) / baseline.named_storms) * 100) : null;
            html += `
                <div class="metric-box">
                    <div class="metric-label">Named Storms</div>
                    <div class="metric-value">${stats.named_storms}</div>
                    <div class="metric-unit">per season</div>
                    ${namedChange !== null ? `<div class="metric-change ${namedChange > 0 ? 'positive' : 'negative'}">${namedChange > 0 ? '+' : ''}${namedChange}% vs baseline</div>` : ''}
                </div>
            `;
            
            // Major hurricanes
            const majorChange = isProjected ? Math.round(((stats.major_hurricanes - baseline.major_hurricanes) / baseline.major_hurricanes) * 100) : null;
            html += `
                <div class="metric-box">
                    <div class="metric-label">Major Hurricanes</div>
                    <div class="metric-value">${stats.major_hurricanes}</div>
                    <div class="metric-unit">Cat 3-5</div>
                    ${majorChange !== null ? `<div class="metric-change ${majorChange > 0 ? 'positive' : 'negative'}">${majorChange > 0 ? '+' : ''}${majorChange}% vs baseline</div>` : ''}
                </div>
            `;
            
            // Landfalls
            const landfallChange = isProjected ? Math.round(((stats.landfalls - baseline.landfalls) / baseline.landfalls) * 100) : null;
            html += `
                <div class="metric-box">
                    <div class="metric-label">US Landfalls</div>
                    <div class="metric-value">${stats.landfalls}</div>
                    <div class="metric-unit">storms</div>
                    ${landfallChange !== null ? `<div class="metric-change ${landfallChange > 0 ? 'positive' : 'negative'}">${landfallChange > 0 ? '+' : ''}${landfallChange}% vs baseline</div>` : ''}
                </div>
            `;
            
            metricsContent.innerHTML = html;
        }

        // Update scenario info panel
        function updateScenarioInfo(mapNum) {
            const dataType = mapNum === 1 ? dataType1 : dataType2;
            const infoPanel = document.getElementById('scenario-info-' + mapNum);
            
            if (dataType === 'historical') {
                const year = document.getElementById('year' + mapNum).value;
                infoPanel.innerHTML = `
                    <h5>Historical Analysis - ${year}</h5>
                    <p>Viewing actual hurricane data from HURDAT2 database with verified tracks and intensities from the ${year} Atlantic hurricane season.</p>
                `;
            } else {
                const scenario = document.getElementById('scenario' + mapNum).value;
                const decade = document.getElementById('decade' + mapNum).value;
                
                const scenarioDescriptions = {
                    'baseline': 'Current climate trends with minimal warming. Represents continuation of historical patterns with slight increases.',
                    'warming_mid': 'Paris Agreement scenario with ~2¬∞C warming. Moderate increases in storm intensity and frequency.',
                    'warming_high': 'High-emissions pathway with ~4¬∞C warming. Significant intensification with more frequent Category 4-5 storms.'
                };
                
                const scenarioNames = {
                    'baseline': 'Baseline Scenario',
                    'warming_mid': '+2¬∞C Warming Scenario',
                    'warming_high': '+4¬∞C Warming Scenario'
                };
                
                infoPanel.innerHTML = `
                    <h5>${scenarioNames[scenario]} - ${decade}</h5>
                    <p>${scenarioDescriptions[scenario]}</p>
                `;
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initMaps();
            
            // Event listeners for controls
            document.getElementById('year1').addEventListener('change', () => updateMap(1));
            document.getElementById('scenario1').addEventListener('change', () => {
                updateMap(1);
                updateScenarioInfo(1);
            });
            document.getElementById('decade1').addEventListener('change', () => {
                updateMap(1);
                updateScenarioInfo(1);
            });
            
            document.getElementById('year2').addEventListener('change', () => updateMap(2));
            document.getElementById('scenario2').addEventListener('change', () => {
                updateMap(2);
                updateScenarioInfo(2);
            });
            document.getElementById('decade2').addEventListener('change', () => {
                updateMap(2);
                updateScenarioInfo(2);
            });

            // Initialize scenario info
            updateScenarioInfo(1);
            updateScenarioInfo(2);
        });
    </script>
</body>
</html>